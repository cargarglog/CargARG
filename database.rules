rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null }
    function isSelf(userId) { return isSignedIn() && request.auth.uid == userId }
    function isStaff() {
      return isSignedIn() && get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'staff'
    }

    // -------- USERS (perfil) --------
    match /users/{userId} {
      allow read, write: if isSelf(userId);
      allow read, update: if isStaff();
    }

    // -------- VERIFICACIÓN DE IDENTIDAD (UNIFICADA) --------
    match /identity_verification_logs/{userId}/attempts/{attemptId} {
      allow create: if isSelf(userId);
      allow read: if isSelf(userId) || isStaff();

      // Usuario puede ACTUALIZAR durante la captura (claves acotadas)
      allow update: if isSelf(userId)
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          'status','dniFrontUri','dniBackUri','selfieUri','updatedAt','userSubmittedDni','reason'
        ]);

      // Staff puede aprobar/rechazar y auditar
      allow update: if isStaff()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          'status','reason','verifiedBy','verifiedAt','updatedAt','finalState','manualVerification'
        ]);

      allow delete: if false;
    }

    // -------- LOADS (índice global de cargas) --------
    match /loads/{loadId} {
      allow create: if isSignedIn();
      allow read: if true;

      // Empresa dueña
      allow update, delete: if isSelf(resource.data.companyId);

      // Chofer: sólo transiciones permitidas
      allow update: if isSignedIn()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['driverId','status'])
        && (
          (resource.data.status == 'available' && request.resource.data.status == 'in_progress' && request.resource.data.driverId == request.auth.uid) ||
          (resource.data.status == 'in_progress' && request.resource.data.status == 'completed' && resource.data.driverId == request.auth.uid)
        );
    }

    // -------- LEGACY congelado --------
    match /users/{userId}/loads/{loadId} {
      allow read: if isSelf(userId);
      allow write: if false;
    }
  }
}
