const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BK2eRnKF.js","assets/vendor-CuDMUxSy.js","assets/genai-BuPwoIhQ.js","assets/firebase-v84oFIZ0.js","assets/index-8Q2q8G1x.css"])))=>i.map(i=>d[i]);
import{d as D,_ as R,f as U,s as N}from"./index-BK2eRnKF.js";import{f as O,q as P,l as S,o as B,h as k,m as I,t as _,p as v,J as w,n as A}from"./firebase-v84oFIZ0.js";import"./vendor-CuDMUxSy.js";import"./genai-BuPwoIhQ.js";async function z(u){const i=O(D,"identity_verification_logs",u,"attempts"),t=P(i,B("createdAt","desc"),S(1)),a=await k(t);let s=0;if(!a.empty){const p=a.docs[0],o=p.data();if(s=o?.attemptNumber||0,o?.status==="in_progress")return{ref:p.ref,attemptNumber:o.attemptNumber}}const e=s+1,n=I(i),m=e===1?"IA":e===2?"DocumentAI":e===3?"HumiOberif":"Staff";return await _(n,{attemptId:n.id,attemptNumber:e,provider:m,status:"in_progress",components:{},createdAt:A(),updatedAt:A()},{merge:!0}),{ref:n,attemptNumber:e}}async function H(u){const{uid:i,attemptRef:t,attemptNumber:a,selfieUri:s,dniFrontUri:e,dniBackUri:n,licenseFrontUri:m,licenseBackUri:p,dniNumber:o}=u,f=a===1?"IA":a===2?"DocumentAI":a===3?"HumiOberif":"Staff";let g=null;if(o)try{const d=await v(I(D,"dniRegistry",o));if(d.exists()){const r=d.data();r?.uid&&r.uid!==i&&(g=r.uid)}}catch{}let b=.6,h;try{if(f==="IA"){const{checkDocumentConsistency:d}=await R(async()=>{const{checkDocumentConsistency:l}=await import("./index-BK2eRnKF.js").then(c=>c.g);return{checkDocumentConsistency:l}},__vite__mapDeps([0,1,2,3,4])),r=await d(await y(e),n?await y(n):"",await y(s),o||"");b=r.success?.8:.5,h={reason:r.reason}}else if(f==="DocumentAI"){const d=w(U,"analyzeWithVisionAndDocAI"),r=x({dniFrontUri:e,dniBackUri:n,licenseFrontUri:m,licenseBackUri:p}),l=await d({uid:i,attemptId:t.id,attemptPath:t.path,dniNumber:o||null,gcsUris:{front:r.dniFrontUri,back:r.dniBackUri},countryISO2:"AR"});let c=l?.data?.confidenceScore;typeof c=="number"&&c>1.5&&(c=c/100),b=typeof c=="number"?c:.8,h=l?.data?.extractedData}else f==="HumiOberif"&&await w(U,"startPremiumVerification")({uid:i,attemptId:t.id,countryISO2:"AR",assets:{frontUri:e,backUri:n,selfieUri:s,videoUri:null}})}catch{}await _(t,{provider:f,confidenceScore:b,duplicateOfUid:g||null,attemptStatus:"pending",status:"pending",updatedAt:A(),components:void 0},{merge:!0})}async function y(u){const t=await(await fetch(u)).blob();return new Promise((a,s)=>{const e=new FileReader;e.onloadend=()=>{const n=e.result||"";a(n.split(",")[1]||"")},e.onerror=s,e.readAsDataURL(t)})}function x(u){const i=N.app?.options?.storageBucket,t={};return Object.entries(u).forEach(([a,s])=>{if(!s){t[a]=void 0;return}if(s.startsWith("gs://")){t[a]=s;return}try{const n=new URL(s).pathname.split("/o/")[1]||"",m=decodeURIComponent(n);i&&m?t[a]=`gs://${i}/${m}`:t[a]=s}catch{t[a]=s}}),t}export{H as finalizeAttemptAndRoute,z as startOrResumeAttempt};
